<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:OrchidPro.ViewModels.Families"
             xmlns:mct="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             xmlns:sflistview="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
             xmlns:sfpulltorefresh="clr-namespace:Syncfusion.Maui.PullToRefresh;assembly=Syncfusion.Maui.PullToRefresh"
             x:Class="OrchidPro.Views.Pages.FamiliesListSyncfusionPage"
             x:DataType="vm:FamiliesListSyncfusionViewModel"
             x:Name="ParentPage"
             Title="Families"
             BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.NavBarIsVisible="True"
             Shell.BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.ForegroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
             Shell.TitleColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}">

    <!-- Status bar configuration -->
    <ContentPage.Behaviors>
        <mct:StatusBarBehavior StatusBarColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                               StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <!-- Main content with fade animation support -->
    <Grid x:Name="ListRootGrid" Opacity="0">

        <!-- Main content card -->
        <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                Stroke="Transparent"
                StrokeThickness="0"
                Margin="10,20,10,10"
                Padding="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,*">

                <!-- Header with statistics and connection status -->
                <Border Grid.Row="0" 
                        BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SurfaceDark}}"
                        Padding="20,15">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16,16,0,0" />
                    </Border.StrokeShape>

                    <!-- Statistics and connection status in single row -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">

                        <!-- Statistics on the left -->
                        <Label Grid.Column="0"
                               FontSize="13"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                               VerticalOptions="Center">
                            <Label.Text>
                                <MultiBinding StringFormat="{}{0} families • {1} active • {2} favorites">
                                    <Binding Path="TotalCount" />
                                    <Binding Path="ActiveCount" />
                                    <Binding Path="FavoriteCount" />
                                </MultiBinding>
                            </Label.Text>
                        </Label>

                        <!-- Connection status on the right -->
                        <Border Grid.Column="1"
                                BackgroundColor="{Binding ConnectionStatusColor}"
                                Padding="8,4"
                                VerticalOptions="Center">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Label Text="{Binding ConnectionStatus}"
                                   FontSize="10"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                        </Border>
                    </Grid>
                </Border>

                <!-- Main content with search and list -->
                <Grid Grid.Row="1" RowDefinitions="Auto,*">

                    <!-- Search bar with darker background -->
                    <Border Grid.Row="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                            Padding="20,15">

                        <Grid ColumnDefinitions="2*,Auto,Auto" ColumnSpacing="10">

                            <!-- Search field expanded with white background -->
                            <Border Grid.Column="0"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray700}}"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                    StrokeThickness="1"
                                    HeightRequest="44">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="22" />
                                </Border.StrokeShape>

                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10" Margin="15,0">
                                    <Label Grid.Column="0" 
                                           Text="🔍"
                                           FontSize="16"
                                           VerticalOptions="Center" />

                                    <Entry Grid.Column="1"
                                           Text="{Binding SearchText}"
                                           Placeholder="Search families..."
                                           FontSize="14"
                                           BackgroundColor="Transparent"
                                           ReturnCommand="{Binding ApplyFilterCommand}"
                                           VerticalOptions="Center"
                                           Focused="OnSearchFocused"
                                           Unfocused="OnSearchUnfocused"
                                           TextChanged="OnSearchTextChanged" />

                                    <Button Grid.Column="2"
                                            Text="✕"
                                            FontSize="12"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                            Command="{Binding ClearSearchCommand}"
                                            IsVisible="{Binding SearchText, Converter={StaticResource StringToBoolConverter}}" />
                                </Grid>
                            </Border>

                            <!-- Filter button - icon only -->
                            <Border Grid.Column="1"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                    Stroke="Transparent"
                                    Padding="12,0"
                                    HeightRequest="44"
                                    WidthRequest="44">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="22" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnFilterTapped" />
                                </Border.GestureRecognizers>

                                <Label Text="📊"
                                       FontSize="16"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center" />
                            </Border>

                            <!-- Sort button - icon only -->
                            <Border Grid.Column="2"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                    Stroke="Transparent"
                                    Padding="12,0"
                                    HeightRequest="44"
                                    WidthRequest="44">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="22" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSortTapped" />
                                </Border.GestureRecognizers>

                                <Label Text="🔄"
                                       FontSize="16"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center" />
                            </Border>
                        </Grid>
                    </Border>

                    <!-- ✅ Syncfusion ListView com pull-to-refresh e binding direto -->
                    <sfpulltorefresh:SfPullToRefresh x:Name="ListRefresh"
                                                     Grid.Row="1"
                                                     IsRefreshing="{Binding IsRefreshing}"
                                                     RefreshCommand="{Binding RefreshCommand}">

                        <Grid>
                            <!-- ✅ CORREÇÃO PRINCIPAL: ItemsSource binding direto + template melhorado -->
                            <sflistview:SfListView x:Name="FamilyListView"
                                                   ItemsSource="{Binding Items}"
                                                   SelectionMode="None"
                                                   ItemTapped="OnItemTapped"
                                                   ItemLongPress="OnItemLongPress"
                                                   SelectionChanged="OnSelectionChanged"
                                                   SwipeStarting="OnSwipeStarting"
                                                   Swiping="OnSwiping"
                                                   SwipeEnded="OnSwipeEnded"
                                                   ItemSpacing="8"
                                                   ScrollBarVisibility="Never"
                                                   BackgroundColor="Transparent"
                                                   Margin="10,0"
                                                   ItemSize="140"
                                                   AutoFitMode="Height"
                                                   AllowSwiping="False">

                                <!-- ✅ TEMPLATE COMPLETO E PROFISSIONAL -->
                                <sflistview:SfListView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:FamilyItemViewModel">
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                                                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                                StrokeThickness="1"
                                                Margin="8,4"
                                                Padding="0">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <!-- Gradient overlay for favorites -->
                                            <Grid>
                                                <Rectangle Fill="{AppThemeBinding Light=#10FF9800, Dark=#20FF9800}"
                                                          IsVisible="{Binding IsFavorite}"
                                                          RadiusX="12"
                                                          RadiusY="12" />

                                                <Grid Padding="16,12" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
                                                    <Grid.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnItemContextMenuRequested" NumberOfTapsRequired="2" />
                                                    </Grid.GestureRecognizers>

                                                    <!-- Header row with name and favorite/status indicators -->
                                                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                                                        <Label Grid.Column="0"
                                                               Text="{Binding Name}"
                                                               FontSize="18"
                                                               FontAttributes="Bold"
                                                               TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource OnSurfaceDark}}"
                                                               LineBreakMode="TailTruncation"
                                                               VerticalOptions="Center" />

                                                        <!-- Favorite indicator -->
                                                        <Label Grid.Column="1"
                                                               Text="⭐"
                                                               FontSize="16"
                                                               IsVisible="{Binding IsFavorite}"
                                                               VerticalOptions="Center" />

                                                        <!-- Status badge -->
                                                        <Border Grid.Column="2"
                                                                BackgroundColor="{Binding StatusBadgeColor}"
                                                                Padding="8,4"
                                                                VerticalOptions="Center">
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="8" />
                                                            </Border.StrokeShape>
                                                            <Label Text="{Binding StatusDisplay}"
                                                                   FontSize="10"
                                                                   FontAttributes="Bold"
                                                                   TextColor="White" />
                                                        </Border>
                                                    </Grid>

                                                    <!-- Description preview -->
                                                    <Label Grid.Row="1"
                                                           Text="{Binding DescriptionPreview}"
                                                           FontSize="14"
                                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="2"
                                                           IsVisible="{Binding DescriptionPreview, Converter={StaticResource StringToBoolConverter}}" />

                                                    <!-- Metadata row -->
                                                    <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                        <!-- Family type indicator -->
                                                        <Label Grid.Column="0"
                                                               Text="{Binding FamilyTypeIndicator}"
                                                               FontSize="14"
                                                               VerticalOptions="Center" />

                                                        <!-- Creation date -->
                                                        <Label Grid.Column="1"
                                                               Text="{Binding CreatedAt, StringFormat='Created {0:dd/MM/yyyy}'}"
                                                               FontSize="12"
                                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                                               VerticalOptions="Center" />

                                                        <!-- Recent indicator -->
                                                        <Label Grid.Column="2"
                                                               Text="{Binding RecentIndicator}"
                                                               FontSize="12"
                                                               VerticalOptions="Center"
                                                               IsVisible="{Binding RecentIndicator, Converter={StaticResource StringToBoolConverter}}" />
                                                    </Grid>

                                                    <!-- Additional indicators for special families -->
                                                    <Label Grid.Row="3"
                                                           Text="{Binding FullStatusDisplay}"
                                                           FontSize="11"
                                                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray600}}"
                                                           IsVisible="{Binding FullStatusDisplay, Converter={StaticResource StringToBoolConverter}}" />

                                                    <!-- Selection checkbox (multi-select mode) -->
                                                    <Border Grid.Row="0"
                                                            Grid.RowSpan="4"
                                                            BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                            Stroke="Transparent"
                                                            Padding="8,4"
                                                            HorizontalOptions="Start"
                                                            VerticalOptions="Start"
                                                            IsVisible="{Binding Source={x:Reference ParentPage}, Path=BindingContext.IsMultiSelectMode}">
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="12" />
                                                        </Border.StrokeShape>
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding ToggleFamilySelectionCommand}" />
                                                        </Border.GestureRecognizers>
                                                        <Label Text="{Binding IsSelected, Converter={StaticResource BoolToStringConverter}, ConverterParameter='☑️|☐'}"
                                                               FontSize="16"
                                                               TextColor="White"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center" />
                                                    </Border>
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </sflistview:SfListView.ItemTemplate>

                                <!-- ✅ EMPTY VIEW MELHORADO -->
                                <sflistview:SfListView.EmptyView>
                                    <VerticalStackLayout Spacing="20" Padding="40" VerticalOptions="Center">
                                        <Label Text="🌿"
                                               FontSize="64"
                                               HorizontalOptions="Center" />
                                        <Label Text="{Binding EmptyStateMessage}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center" />
                                        <Label Text="Tap the + button to add your first family"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center" />

                                        <!-- Quick add button in empty state -->
                                        <Button Text="Add Family"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                TextColor="White"
                                                FontSize="16"
                                                FontAttributes="Bold"
                                                CornerRadius="25"
                                                WidthRequest="150"
                                                HeightRequest="50"
                                                Command="{Binding AddNewCommand}"
                                                IsVisible="{Binding IsConnected}"
                                                Margin="0,10,0,0" />
                                    </VerticalStackLayout>
                                </sflistview:SfListView.EmptyView>

                            </sflistview:SfListView>

                            <!-- Loading overlay outside ListView -->
                            <Grid IsVisible="{Binding IsLoading}"
                                  BackgroundColor="#80000000">
                                <VerticalStackLayout Spacing="15"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center">
                                    <ActivityIndicator IsRunning="{Binding IsLoading}"
                                                       Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}"
                                                       WidthRequest="40"
                                                       HeightRequest="40" />
                                    <Label Text="Loading families..."
                                           TextColor="White"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Grid>
                        </Grid>

                    </sfpulltorefresh:SfPullToRefresh>

                </Grid>
            </Grid>
        </Border>

        <!-- ✅ FAB BUTTON OTIMIZADO -->
        <Button x:Name="FabButton"
                Text="{Binding FabText}"
                FontSize="14"
                FontAttributes="Bold"
                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                TextColor="White"
                CornerRadius="28"
                WidthRequest="140"
                HeightRequest="56"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20,20,30,30"
                IsVisible="{Binding FabIsVisible}"
                IsEnabled="{Binding IsConnected}"
                Scale="0.9"
                Command="{Binding AddNewCommand}">
            <Button.Shadow>
                <Shadow Brush="Black" Opacity="0.3" Radius="10" Offset="0,4" />
            </Button.Shadow>
        </Button>

    </Grid>

</ContentPage>