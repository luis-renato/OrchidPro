<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:OrchidPro.ViewModels.Families"
             xmlns:mct="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             xmlns:sflistview="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
             xmlns:sfpulltorefresh="clr-namespace:Syncfusion.Maui.PullToRefresh;assembly=Syncfusion.Maui.PullToRefresh"
             x:Class="OrchidPro.Views.Pages.FamiliesListSyncfusionPage"
             x:DataType="vm:FamiliesListSyncfusionViewModel"
             x:Name="ParentPage"
             Title="Families"
             BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.NavBarIsVisible="True"
             Shell.BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.ForegroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
             Shell.TitleColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}">

    <!-- Status bar configuration -->
    <ContentPage.Behaviors>
        <mct:StatusBarBehavior StatusBarColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                               StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <!-- Main content with fade animation support -->
    <Grid x:Name="ListRootGrid" Opacity="0">

        <!-- Main content card -->
        <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                Stroke="Transparent"
                StrokeThickness="0"
                Margin="10,20,10,10"
                Padding="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,Auto,*">

                <!-- Header with statistics and connection status -->
                <Border Grid.Row="0" 
                        BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SurfaceDark}}"
                        Padding="20,15">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16,16,0,0" />
                    </Border.StrokeShape>

                    <Grid RowDefinitions="Auto,Auto" RowSpacing="10">
                        <!-- Title and connectivity status -->
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                <Label Text="Botanical Families"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource White}}" />
                                <Label Text="Manage your botanical family collection with advanced features"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                            </VerticalStackLayout>

                            <!-- Connectivity indicator -->
                            <Border Grid.Column="1"
                                    BackgroundColor="{Binding ConnectionStatusColor}"
                                    Padding="10,5"
                                    VerticalOptions="Start">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Label Text="{Binding ConnectionStatus}"
                                       FontSize="11"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center" />
                            </Border>
                        </Grid>

                        <!-- Statistics -->
                        <Grid Grid.Row="1" ColumnDefinitions="*,*">
                            <!-- Total families -->
                            <Border Grid.Column="0" 
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource Gray900}}"
                                    Stroke="{StaticResource BorderColor}"
                                    StrokeThickness="1"
                                    Padding="12,8"
                                    Margin="0,0,5,0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="{Binding TotalCount}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Total"
                                           FontSize="10"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Active families -->
                            <Border Grid.Column="1" 
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource Gray900}}"
                                    Stroke="{StaticResource BorderColor}"
                                    StrokeThickness="1"
                                    Padding="12,8"
                                    Margin="5,0,0,0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="{Binding ActiveCount}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource SuccessColor}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Active"
                                           FontSize="10"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>

                <!-- ✅ Search and filters section with SORT UI -->
                <Grid Grid.Row="1" 
                      Padding="20,15,20,10"
                      ColumnDefinitions="*"
                      RowDefinitions="Auto,Auto,Auto"
                      RowSpacing="10">

                    <!-- Search bar -->
                    <Border Grid.Row="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                            Stroke="{StaticResource BorderColor}"
                            StrokeThickness="1"
                            Padding="15,10">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="25" />
                        </Border.StrokeShape>

                        <Grid ColumnDefinitions="*,Auto">
                            <Entry Grid.Column="0"
                                   Text="{Binding SearchText}"
                                   Placeholder="Search families..."
                                   BackgroundColor="Transparent"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource White}}"
                                   PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                   IsEnabled="{Binding IsConnected}" />

                            <Button Grid.Column="1"
                                    Text="✕"
                                    Command="{Binding ClearFilterCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    CornerRadius="15"
                                    Padding="0"
                                    IsVisible="{Binding SearchText, Converter={StaticResource StringToBoolConverter}}"
                                    IsEnabled="{Binding IsConnected}" />
                        </Grid>
                    </Border>

                    <!-- ✅ Filter and Sort Controls -->
                    <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="10">

                        <!-- Status Filter Button -->
                        <Button Grid.Column="0"
                                Text="{Binding StatusFilter, StringFormat='Status: {0}'}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Gray600}}"
                                TextColor="{AppThemeBinding Light={StaticResource OnPrimary}, Dark={StaticResource White}}"
                                FontSize="12"
                                Padding="12,8"
                                CornerRadius="15"
                                Clicked="OnStatusFilterTapped"
                                IsEnabled="{Binding IsConnected}" />

                        <!-- ✅ Sort Button -->
                        <Button Grid.Column="1"
                                Text="🔄"
                                BackgroundColor="{AppThemeBinding Light={StaticResource InfoColor}, Dark={StaticResource InfoColor}}"
                                TextColor="White"
                                FontSize="14"
                                WidthRequest="40"
                                HeightRequest="40"
                                CornerRadius="20"
                                Clicked="OnSortTapped"
                                IsEnabled="{Binding IsConnected}"
                                ToolTipProperties.Text="Sort families" />
                    </Grid>

                    <!-- ✅ Current Sort Display -->
                    <Border Grid.Row="2"
                            BackgroundColor="{AppThemeBinding Light={StaticResource InfoColor}, Dark={StaticResource InfoColor}}"
                            Padding="10,6"
                            Opacity="0.9"
                            IsVisible="{Binding SortOrder, Converter={StaticResource StringToBoolConverter}}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <Label Text="{Binding SortOrder, StringFormat='Sorted by: {0}'}"
                               FontSize="11"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center" />
                    </Border>
                </Grid>

                <!-- ✅ Main content area with PULL TO REFRESH -->
                <Grid Grid.Row="2">

                    <!-- ✅ SYNCFUSION PULL TO REFRESH -->
                    <sfpulltorefresh:SfPullToRefresh x:Name="ListRefresh"
                                                     RefreshViewHeight="50"
                                                     RefreshViewThreshold="30"
                                                     PullingThreshold="150"
                                                     RefreshViewWidth="50"
                                                     TransitionMode="SlideOnTop"
                                                     ProgressColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                     IsRefreshing="{Binding IsRefreshing}"
                                                     RefreshCommand="{Binding RefreshCommand}"
                                                     IsEnabled="{Binding IsConnected}">

                        <sfpulltorefresh:SfPullToRefresh.PullableContent>
                            <!-- ✅ SYNCFUSION LISTVIEW COM SWIPE E MULTI-SELECT (SEM DATASOURCE) -->
                            <sflistview:SfListView x:Name="FamilyListView"
                                                   ItemsSource="{Binding Items}"
                                                   ItemSize="90"
                                                   AllowSwiping="True"
                                                   SwipeOffset="90"
                                                   SwipeThreshold="90"
                                                   SelectionMode="None"
                                                   SelectionGesture="Tap"
                                                   IsVisible="{Binding HasData}"
                                                   ItemTapped="OnItemTapped"
                                                   ItemLongPress="OnItemLongPress"
                                                   SwipeStarting="OnSwipeStarting"
                                                   Swiping="OnSwiping"
                                                   SwipeEnded="OnSwipeEnded"
                                                   SelectionChanged="OnSelectionChanged">

                                <!-- ✅ RIGHT SWIPE: Favorite action -->
                                <sflistview:SfListView.StartSwipeTemplate>
                                    <DataTemplate>
                                        <Grid BackgroundColor="#FF9800" 
                                              HorizontalOptions="Fill" 
                                              VerticalOptions="Fill">
                                            <Label Text="⭐"
                                                   FontSize="28"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   TextColor="White" />
                                        </Grid>
                                    </DataTemplate>
                                </sflistview:SfListView.StartSwipeTemplate>

                                <!-- ✅ LEFT SWIPE: Delete action -->
                                <sflistview:SfListView.EndSwipeTemplate>
                                    <DataTemplate>
                                        <Grid BackgroundColor="{StaticResource ErrorColor}" 
                                              HorizontalOptions="Fill" 
                                              VerticalOptions="Fill">
                                            <Label Text="🗑️"
                                                   FontSize="28"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   TextColor="White" />
                                        </Grid>
                                    </DataTemplate>
                                </sflistview:SfListView.EndSwipeTemplate>

                                <!-- ✅ ITEM TEMPLATE COM SELEÇÃO -->
                                <sflistview:SfListView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:FamilyItemViewModel">
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                                                Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2196F3|Transparent'}"
                                                StrokeThickness="{Binding IsSelected, Converter={StaticResource BoolToIntConverter}, ConverterParameter='3|1'}"
                                                Padding="20,15"
                                                Margin="20,5">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Grid ColumnDefinitions="*,Auto"
                                                  RowDefinitions="Auto,Auto"
                                                  ColumnSpacing="15"
                                                  RowSpacing="8">

                                                <!-- Content area -->
                                                <VerticalStackLayout Grid.Row="0" Grid.Column="0" 
                                                                     Spacing="4">
                                                    <Grid ColumnDefinitions="*,Auto">
                                                        <Label Grid.Column="0"
                                                               Text="{Binding DisplayName}"
                                                               FontSize="16"
                                                               FontAttributes="Bold"
                                                               TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource White}}"
                                                               LineBreakMode="TailTruncation" />

                                                        <!-- ✅ Selection indicator -->
                                                        <Label Grid.Column="1"
                                                               Text="{Binding SelectionIcon}"
                                                               FontSize="16"
                                                               IsVisible="{Binding IsSelected}"
                                                               TextColor="{StaticResource Primary}" />
                                                    </Grid>

                                                    <Label Text="{Binding DescriptionPreview}"
                                                           FontSize="12"
                                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="2" />
                                                </VerticalStackLayout>

                                                <!-- Status indicators -->
                                                <VerticalStackLayout Grid.Row="0" Grid.Column="1" 
                                                                     Spacing="4"
                                                                     HorizontalOptions="End">

                                                    <!-- Active/Inactive status -->
                                                    <Border BackgroundColor="{Binding StatusBadgeColor}"
                                                            Padding="8,4"
                                                            HorizontalOptions="End">
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="10" />
                                                        </Border.StrokeShape>
                                                        <Label Text="{Binding StatusBadge}"
                                                               FontSize="10"
                                                               FontAttributes="Bold"
                                                               TextColor="White" />
                                                    </Border>

                                                    <!-- ✅ Favorite indicator -->
                                                    <Label Text="⭐"
                                                           FontSize="14"
                                                           IsVisible="{Binding IsFavorite}"
                                                           HorizontalOptions="End" />
                                                </VerticalStackLayout>

                                                <!-- Metadata -->
                                                <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                      ColumnDefinitions="Auto,*,Auto"
                                                      ColumnSpacing="10">

                                                    <Label Grid.Column="0"
                                                           Text="{Binding CreatedAtFormatted, StringFormat='Created: {0}'}"
                                                           FontSize="10"
                                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />

                                                    <Label Grid.Column="2"
                                                           Text="System Default"
                                                           FontSize="10"
                                                           FontAttributes="Italic"
                                                           TextColor="{AppThemeBinding Light={StaticResource InfoColor}, Dark={StaticResource InfoColor}}"
                                                           IsVisible="{Binding IsSystemDefault}" />
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </sflistview:SfListView.ItemTemplate>

                                <!-- ✅ EMPTY VIEW MELHORADO -->
                                <sflistview:SfListView.EmptyView>
                                    <VerticalStackLayout Spacing="20" Padding="40" VerticalOptions="Center">
                                        <Label Text="🌿"
                                               FontSize="64"
                                               HorizontalOptions="Center" />
                                        <Label Text="{Binding EmptyStateMessage}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center" />
                                        <Label Text="Tap the + button to add your first family"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center" />

                                        <!-- Quick add button in empty state -->
                                        <Button Text="Add Family"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                TextColor="White"
                                                FontSize="16"
                                                FontAttributes="Bold"
                                                CornerRadius="25"
                                                Padding="30,15"
                                                Command="{Binding AddNewCommand}"
                                                IsVisible="{Binding IsConnected}" />

                                        <Button Text="Test Connection"
                                                Command="{Binding TestConnectionCommand}"
                                                BackgroundColor="{StaticResource InfoColor}"
                                                TextColor="White"
                                                CornerRadius="25"
                                                Padding="30,15"
                                                IsVisible="{Binding IsConnected, Converter={StaticResource InvertedBoolConverter}}" />
                                    </VerticalStackLayout>
                                </sflistview:SfListView.EmptyView>
                            </sflistview:SfListView>
                        </sfpulltorefresh:SfPullToRefresh.PullableContent>
                    </sfpulltorefresh:SfPullToRefresh>

                    <!-- Loading overlay -->
                    <Grid IsVisible="{Binding IsLoading}"
                          BackgroundColor="#80000000">
                        <VerticalStackLayout Spacing="15"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center">
                            <ActivityIndicator IsRunning="{Binding IsLoading}"
                                               Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                               WidthRequest="40"
                                               HeightRequest="40" />
                            <Label Text="Loading families..."
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource White}}"
                                   FontSize="14"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Grid>
                </Grid>
            </Grid>
        </Border>

        <!-- ✅ FLOATING ACTION BUTTON DINÂMICO -->
        <Button x:Name="FabButton"
                Text="{Binding FabText}"
                FontSize="14"
                FontAttributes="Bold"
                CornerRadius="28"
                WidthRequest="160"
                HeightRequest="56"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20,20,30,30"
                IsVisible="{Binding FabIsVisible}"
                IsEnabled="{Binding IsConnected}"
                Scale="0.9"
                Clicked="OnFabPressed">

            <!-- ✅ FAB dinâmico baseado no estado -->
            <Button.Style>
                <Style TargetType="Button">
                    <!-- Default style -->
                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                    <Setter Property="TextColor" Value="{StaticResource OnPrimary}" />

                    <Style.Triggers>
                        <!-- Delete mode when items selected -->
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding SelectedItems.Count, Converter={StaticResource IntToBoolConverter}}"
                                     Value="True">
                            <Setter Property="BackgroundColor" Value="#D32F2F" />
                            <Setter Property="TextColor" Value="White" />
                        </DataTrigger>

                        <!-- Cancel mode when in multi-select but no items selected -->
                        <MultiTrigger TargetType="Button">
                            <MultiTrigger.Conditions>
                                <BindingCondition Binding="{Binding IsMultiSelectMode}" Value="True" />
                                <BindingCondition Binding="{Binding SelectedItems.Count}" Value="0" />
                            </MultiTrigger.Conditions>
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray600}}" />
                            <Setter Property="TextColor" Value="White" />
                        </MultiTrigger>

                        <!-- Offline state -->
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding IsConnected}"
                                     Value="False">
                            <Setter Property="BackgroundColor" Value="{StaticResource Gray400}" />
                            <Setter Property="IsEnabled" Value="False" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Button.Style>
        </Button>
    </Grid>
</ContentPage>