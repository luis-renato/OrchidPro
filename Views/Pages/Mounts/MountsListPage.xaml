<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:OrchidPro.ViewModels.Mounts"
             xmlns:mct="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             xmlns:toolkit="clr-namespace:CommunityToolkit.Maui.Converters;assembly=CommunityToolkit.Maui"
             xmlns:sflistview="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
             xmlns:sfpulltorefresh="clr-namespace:Syncfusion.Maui.PullToRefresh;assembly=Syncfusion.Maui.PullToRefresh"
             xmlns:sfbusy="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
             xmlns:sfbutton="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
             x:Class="OrchidPro.Views.Pages.Mounts.MountsListPage"
             x:DataType="vm:MountsListViewModel"
             x:Name="ParentPage"
             Title="Mounts"
             BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.NavBarIsVisible="True"
             Shell.BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
             Shell.ForegroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
             Shell.TitleColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="  Select All"
                     Clicked="OnSelectAllTapped"
                     Order="Primary"
                     Priority="0" />
        <ToolbarItem Text="Clear  "
                     Clicked="OnDeselectAllTapped"
                     Order="Primary" 
                     Priority="1" />
    </ContentPage.ToolbarItems>

    <ContentPage.Behaviors>
        <mct:StatusBarBehavior StatusBarColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                               StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <Grid x:Name="RootGrid">

        <!-- 1. MAIN CONTENT GRID - Hidden during loading -->
        <Grid x:Name="ContentGrid" 
              IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
              Opacity="0">

            <!-- Main content card -->
            <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                    Stroke="Transparent"
                    StrokeThickness="0"
                    Margin="10,15,10,10"
                    Padding="0">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>

                <Grid RowDefinitions="Auto,Auto,*">

                    <!-- Header with statistics and connection status -->
                    <Border Grid.Row="0" 
                            BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SurfaceDark}}"
                            Padding="15,8">

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">
                            <Label Grid.Column="0"
                                   FontSize="13"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                   VerticalOptions="Center">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0} Mounts • {1} active • {2} favorites">
                                        <Binding Path="TotalCount" />
                                        <Binding Path="ActiveCount" />
                                        <Binding Path="FavoriteCount" FallbackValue="0" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>

                            <Border Grid.Column="1"
                                    BackgroundColor="{Binding ConnectionStatusColor}"
                                    Padding="8,4"
                                    VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Label Text="{Binding ConnectionStatus}"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Search bar - STANDARDIZED to match families -->
                    <Border Grid.Row="1" Style="{StaticResource SearchBarContainerStyle}">
                        <Grid ColumnDefinitions="2*,Auto,Auto" ColumnSpacing="5" Padding="2,0,2,0">
                            <!-- Search field -->
                            <Border Grid.Column="0" Style="{StaticResource SearchFieldBorderStyle}" >
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="0" Margin="5,0,5,0">
                                    <Entry Grid.Column="1"
                                           Text="{Binding SearchText}"
                                           Placeholder="Search..."
                                           Style="{StaticResource SearchEntryStyle}"
                                           ReturnCommand="{Binding ApplyFilterCommand}"
                                           Focused="OnSearchFocused"
                                           Unfocused="OnSearchUnfocused"
                                           TextChanged="OnSearchTextChanged" />
                                    <Button Grid.Column="2"
                                            Style="{StaticResource SearchClearButtonStyle}"
                                            Command="{Binding ClearFilterCommand}"
                                            IsVisible="{Binding SearchText, Converter={StaticResource StringToBoolConverter}}" />
                                </Grid>
                            </Border>
                            <!-- Filter button -->
                            <Border Grid.Column="1" Style="{StaticResource SearchActionButtonStyle}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnFilterTapped" />
                                </Border.GestureRecognizers>
                                <Label Text="📊" Style="{StaticResource SearchActionIconStyle}" />
                            </Border>
                            <!-- Sort button -->
                            <Border Grid.Column="2" Style="{StaticResource SearchActionButtonStyle}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSortTapped" />
                                </Border.GestureRecognizers>
                                <Label Text="🔄" Style="{StaticResource SearchActionIconStyle}" />
                            </Border>
                        </Grid>
                    </Border>

                    <!-- ListView container -->
                    <sfpulltorefresh:SfPullToRefresh x:Name="ListRefresh"
                                        Grid.Row="2" 
                                        IsRefreshing="{Binding IsRefreshing}"
                                        RefreshViewThreshold="40"
                                        PullingThreshold="40"
                                        TransitionMode="Push"
                                        ProgressBackground = "{StaticResource Primary}"
                                        ProgressColor = "White"
                                        ProgressThickness="3"
                                        RefreshViewWidth="40"
                                        RefreshViewHeight="40">
                        <sfpulltorefresh:SfPullToRefresh.PullableContent>

                            <sflistview:SfListView x:Name="MountListView"
                                               ItemsSource="{Binding Items}"
                                               SelectionMode="Multiple"
                                               SelectionGesture="LongPress"
                                               SelectionBackground="{AppThemeBinding Light=#E8D5C4, Dark=#4A3A30}"
                                               ItemTapped="OnItemTapped"
                                               ItemLongPress="OnItemLongPress"
                                               SelectionChanged="OnSelectionChanged"
                                               SwipeStarting="OnSwipeStarting"
                                               Swiping="OnSwiping"
                                               SwipeEnded="OnSwipeEnded"
                                               ItemSpacing="0"
                                               BackgroundColor="Transparent"
                                               ScrollBarVisibility="Never"
                                               Margin="0,0,0,0"
                                               ItemSize="100"
                                               AllowSwiping="True"
                                               SwipeOffset="90"
                                               SwipeThreshold="90">

                                <sflistview:SfListView.StartSwipeTemplate>
                                    <DataTemplate>
                                        <Grid BackgroundColor="{AppThemeBinding Light={StaticResource WarningColor}, Dark={StaticResource WarningColor}}" 
                                              HorizontalOptions="Fill" 
                                              VerticalOptions="Fill">
                                            <Label Text="⭐"
                                                   FontSize="32"
                                                   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </DataTemplate>
                                </sflistview:SfListView.StartSwipeTemplate>

                                <sflistview:SfListView.EndSwipeTemplate>
                                    <DataTemplate>
                                        <Grid BackgroundColor="{AppThemeBinding Light={StaticResource ErrorColor}, Dark={StaticResource ErrorColor}}" 
                                              HorizontalOptions="Fill" 
                                              VerticalOptions="Fill">
                                            <Label Text="🗑️"
                                                   FontSize="32"
                                                   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </DataTemplate>
                                </sflistview:SfListView.EndSwipeTemplate>

                                <sflistview:SfListView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:MountItemViewModel">
                                        <Grid Margin="0" BackgroundColor="Transparent">
                                            <Border BackgroundColor="#F9F9F9"
                                                Stroke="#E0E0E0"
                                                StrokeThickness="1"
                                                Margin="6,2">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="18" />
                                                </Border.StrokeShape>

                                                <StackLayout Padding="15,12" Spacing="1" BackgroundColor="#EEEEEE">

                                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10" >
                                                        <Label Grid.Column="0"
                                                               Text="Mount"
                                                               FontSize="14"
                                                               FontAttributes="Italic"
                                                               TextColor="#666666"
                                                               VerticalOptions="End" />

                                                        <Label Grid.Column="1"
                                                               Text="⭐"
                                                               FontSize="17"
                                                               IsVisible="{Binding IsFavorite}"
                                                               VerticalOptions="Center" />

                                                        <Border Grid.Column="2"
                                                                BackgroundColor="#4CAF50"
                                                                Padding="10,4"
                                                                VerticalOptions="Center"
                                                                IsVisible="{Binding IsActive}">
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="12" />
                                                            </Border.StrokeShape>
                                                            <Label Text="Active"
                                                                   FontSize="8"
                                                                   FontAttributes="Bold"
                                                                   TextColor="White" />
                                                        </Border>

                                                        <!-- Badge Inactive -->
                                                        <Border Grid.Column="2"
                                                                BackgroundColor="#F44336"
                                                                Padding="10,4"
                                                                VerticalOptions="Center">
                                                            <Border.IsVisible>
                                                                <Binding Path="IsActive">
                                                                    <Binding.Converter>
                                                                        <toolkit:InvertedBoolConverter />
                                                                    </Binding.Converter>
                                                                </Binding>
                                                            </Border.IsVisible>
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="12" />
                                                            </Border.StrokeShape>
                                                            <Label Text="Inactive"
                                                                   FontSize="8"
                                                                   FontAttributes="Bold"
                                                                   TextColor="White" />
                                                        </Border>
                                                    </Grid>

                                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" Margin="0,0,0,4">
                                                        <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalOptions="Start">
                                                            <Label Text="{Binding Name}"
                                                                   FontSize="16"
                                                                   FontAttributes="Bold"
                                                                   TextColor="#333333"
                                                                   VerticalOptions="End" />
                                                        </StackLayout>

                                                        <Label Grid.Column="1"
                                                               Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy}'}"
                                                               FontSize="12"
                                                               TextColor="#999999"
                                                               VerticalOptions="End"
                                                               HorizontalOptions="Center" />
                                                    </Grid>

                                                    <Label Text="{Binding DescriptionPreview}"
                                                           FontSize="12"
                                                           TextColor="#666666"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1"
                                                           IsVisible="{Binding DescriptionPreview, Converter={StaticResource StringToBoolConverter}}" />

                                                    <!-- Mount-specific: Material and Size -->
                                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" Margin="0,4,0,0">
                                                        <Label Grid.Column="0"
                                                               Text="{Binding MaterialDisplay}"
                                                               FontSize="11"
                                                               FontAttributes="Italic"
                                                               TextColor="#9C27B0"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1"
                                                               IsVisible="{Binding Material, Converter={StaticResource StringToBoolConverter}}" />

                                                        <Label Grid.Column="1"
                                                               Text="{Binding SizeDisplay}"
                                                               FontSize="11"
                                                               FontAttributes="Italic"
                                                               TextColor="#FF5722"
                                                               LineBreakMode="TailTruncation"
                                                               MaxLines="1"
                                                               IsVisible="{Binding Size, Converter={StaticResource StringToBoolConverter}}" />
                                                    </Grid>

                                                </StackLayout>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </sflistview:SfListView.ItemTemplate>

                                <!-- EmptyView - STANDARDIZED to match families pattern -->
                                <sflistview:SfListView.EmptyView>
                                    <Grid>
                                        <StackLayout Spacing="20" 
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center"
                                                   Padding="40">

                                            <!-- Mount icon with background -->
                                            <Border BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A148C}"
                                                    Stroke="{AppThemeBinding Light=#9C27B0, Dark=#9C27B0}"
                                                    StrokeThickness="2"
                                                    WidthRequest="80"
                                                    HeightRequest="80"
                                                    HorizontalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="40" />
                                                </Border.StrokeShape>
                                                <Label Text="🏺"
                                                       FontSize="40"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center" />
                                            </Border>

                                            <!-- Text content -->
                                            <StackLayout Spacing="8" HorizontalOptions="Center">
                                                <Label Text="No mounts found"
                                                       FontSize="18"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"
                                                       HorizontalOptions="Center" />
                                                <Label Text="No mounts to display"
                                                       FontSize="14"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                       HorizontalOptions="Center" />
                                            </StackLayout>
                                        </StackLayout>
                                    </Grid>
                                </sflistview:SfListView.EmptyView>

                            </sflistview:SfListView>
                        </sfpulltorefresh:SfPullToRefresh.PullableContent>

                    </sfpulltorefresh:SfPullToRefresh>

                </Grid>
            </Border>
        </Grid>

        <!-- Loading Overlay -->
        <ContentView Style="{StaticResource LoadingOverlayStyle}" />

        <!-- 3. FAB - Hidden during loading, with animation -->
        <Button x:Name="FabButton"
                Text="{Binding FabText, FallbackValue='Add Mount'}"
                Style="{StaticResource FabButtonStyle}"
                IsVisible="False"
                Opacity="0"
                Scale="0.7"
                IsEnabled="{Binding IsConnected, FallbackValue=True}"
                Clicked="OnFabTapped" />

    </Grid>
</ContentPage>